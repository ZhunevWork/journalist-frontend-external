# VERSION 1.0

worker_processes auto;
worker_cpu_affinity auto;
worker_rlimit_nofile 100000;
pid /tmp/nginx.pid;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
    accept_mutex off;
}

http {
    # docker
    resolver 127.0.0.11 valid=5s ipv6=off;
    resolver_timeout 3s;

    # Compression
    ## используется когда нет другого сжатия например на уровне ingress или другом реверс прокси
    gzip on;
    gzip_disable "msie6";
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;
    gzip_types
    application/atom+xml
    application/javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rss+xml
    application/vnd.geo+json
    application/vnd.ms-fontobject
    application/x-font-ttf
    application/x-web-app-manifest+json
    application/xhtml+xml
    application/xml
    font/opentype
    image/bmp
    image/svg+xml
    image/x-icon
    text/cache-manifest
    text/css
    text/plain
    text/vcard
    text/vnd.rim.location.xloc
    text/vtt
    text/x-component
    text/x-cross-domain-policy;

    # Performance optimization
    ## AIO (Asynchronous Input/Output)
    aio threads;
    aio_write on;

    # TCP settings
    sendfile on;
    tcp_nodelay on;
    tcp_nopush on;

    # Buffer settings
    client_header_buffer_size 4k;
    large_client_header_buffers 4 16k;
    client_body_buffer_size 16k;

    # Security
    ignore_invalid_headers on;
    server_tokens off;

    # Timeouts
    keepalive_timeout 65;
    keepalive_requests 100000;
    client_body_timeout 35;
    client_header_timeout 12;
    send_timeout 35;

    # Access Log Format Configuration
    log_format main '{'
    '"time": "$time_local",'
    '"client_ip": "$http_x_forwarded_for"'
    '"remote_addr": "$remote_addr"'
    '"request_method": "$request_method"'
    '"uri": "$uri"'
    '"args": "$args"'
    '"status": "$status"'
    '"body_bytes_sent": "$body_bytes_sent"'
    '"request_length": "$request_length"'
    '"request_time": "$request_time"'
    '"upstream_response_time": "$upstream_response_time"'
    '"upstream_connect_time": "$upstream_connect_time"'
    '"upstream_addr": "$upstream_addr"'
    '"http_user_agent": "$http_user_agent"'
    '"http_referer": "$http_referer"'
    '"host": "$host"'
    '"request_id": "$request_id"'
    '}';

    access_log /dev/stdout main;

    server {
        listen 8080
        default_server
        reuseport
        backlog=4096
        fastopen=3;

        http2 on;

        # TODO change root to default
        root /tmp/wwwroot/dist;
        index index.html;
        include /etc/nginx/mime.types;

        types {
            application/javascript mjs;
        }

        # Additional security headers
        add_header X-Frame-Options DENY always;
        add_header X-Content-Type-Options nosniff always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Endpoints
        set $backend "https://backend.ljournalist.ru";

        # Static files
        location / {
            try_files $uri /index.html;
            add_header Cache-Control "max-age=0, private, must-revalidate" always;
        }

        # API endpoints
        location ~* /api {
            client_max_body_size 400M;

            proxy_pass http://$backend;
            include /etc/nginx/proxy.conf;
        }

        # Static assets with cache
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|mjs)$ {
            access_log off;

            # File cache
            open_file_cache max=2000 inactive=20s;
            open_file_cache_valid 30s;
            open_file_cache_min_uses 2;
            open_file_cache_errors on;

            expires 7d;
            add_header Cache-Control "public, no-transform";
        }
    }
}